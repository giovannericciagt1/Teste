<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Pontos Pulsando com Troca de Mapa Base</title>
    <link rel="stylesheet" href="https://js.arcgis.com/4.30/esri/themes/light/main.css" />
    <script src="https://js.arcgis.com/4.30/"></script>
    <style>
      html, body, #viewDiv {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
      }
      .esri-basemap-gallery {
        background-color: white;
      }
    </style>
  </head>
  <body>
    <div id="viewDiv"></div>
    <script>
      require([
        "esri/Map",
        "esri/views/MapView",
        "esri/layers/FeatureLayer",
        "esri/layers/GraphicsLayer",
        "esri/Graphic",
        "esri/widgets/BasemapGallery",
        "esri/widgets/Expand"
      ], function(Map, MapView, FeatureLayer, GraphicsLayer, Graphic, BasemapGallery, Expand) {

        const map = new Map({
          basemap: "hybrid"  // inicial
        });

        const view = new MapView({
          container: "viewDiv",
          map: map,
          center: [-50.67, -22.65],
          zoom: 10
        });

        // Camada de equipamentos
        const featureLayer = new FeatureLayer({
          url: "https://arcgis.agroterenas.com.br/server/rest/services/Hosted/LAST_DATA_EQUIPMENTS/FeatureServer/0",
          outFields: ["*"]
        });
        map.add(featureLayer);

        // Camada de pontos pulsando
        const pulseLayer = new GraphicsLayer();
        map.add(pulseLayer);

        function drawPulse(features) {
          let grow = true;
          let size = 10;

          setInterval(() => {
            pulseLayer.removeAll();

            features.forEach(f => {
              const alerta = f.attributes["ALERTA_ATIVO"];
              let color = "gray";

              if (alerta && alerta.endsWith("1")) {
                color = "red";
              } else if (alerta && alerta.endsWith("0")) {
                color = "green";
              }

              const pointGraphic = new Graphic({
                geometry: f.geometry,
                symbol: {
                  type: "simple-marker",
                  color: color,
                  size: size,
                  outline: {
                    color: "white",
                    width: 1
                  }
                }
              });

              pulseLayer.add(pointGraphic);
            });

            if (grow) {
              size += 2;
              if (size >= 30) grow = false;
            } else {
              size -= 2;
              if (size <= 10) grow = true;
            }
          }, 300);
        }

        featureLayer.queryFeatures({
          where: "1=1",
          outFields: ["*"],
          returnGeometry: true
        }).then(result => {
          drawPulse(result.features);
        });

        // ðŸ”¹ BasemapGallery (troca de mapas base)
        const basemapGallery = new BasemapGallery({
          view: view
        });

        // Colocar dentro de um Expand (menu flutuante)
        const bgExpand = new Expand({
          view: view,
          content: basemapGallery,
          expandIconClass: "esri-icon-basemap"
        });

        view.ui.add(bgExpand, "top-right");

      });
    </script>
  </body>
</html>
